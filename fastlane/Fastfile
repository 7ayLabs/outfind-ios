# Lapses iOS Fastfile
# Automated build, test, and deployment lanes

default_platform(:ios)

platform :ios do
  # ==================
  # ENVIRONMENT
  # ==================

  before_all do
    setup_ci if ENV['CI']
  end

  # ==================
  # TESTING
  # ==================

  desc "Run all tests"
  lane :test do
    run_tests(
      project: "outfind/lapses.xcodeproj",
      scheme: "lapses",
      device: "iPhone 16",
      clean: true,
      code_coverage: true,
      result_bundle: true,
      output_directory: "./test_output"
    )
  end

  desc "Run tests with code coverage and generate report"
  lane :test_coverage do
    test

    # Generate coverage report (if slather is installed)
    # slather(
    #   proj: "outfind/lapses.xcodeproj",
    #   scheme: "lapses",
    #   output_directory: "./coverage",
    #   cobertura_xml: true,
    #   html: true
    # )
  end

  # ==================
  # LINTING
  # ==================

  desc "Run SwiftLint"
  lane :lint do
    swiftlint(
      mode: :lint,
      config_file: ".swiftlint.yml",
      strict: true,
      raise_if_swiftlint_error: true,
      reporter: "html",
      output_file: "./swiftlint_report.html"
    )
  end

  desc "Auto-fix SwiftLint issues"
  lane :lint_fix do
    swiftlint(
      mode: :fix,
      config_file: ".swiftlint.yml"
    )
  end

  # ==================
  # BUILDING
  # ==================

  desc "Build the app for testing"
  lane :build do
    build_app(
      project: "outfind/lapses.xcodeproj",
      scheme: "lapses",
      configuration: "Debug",
      skip_archive: true,
      skip_codesigning: true,
      destination: "generic/platform=iOS Simulator"
    )
  end

  desc "Build for release"
  lane :build_release do
    build_app(
      project: "outfind/lapses.xcodeproj",
      scheme: "lapses",
      configuration: "Release",
      export_method: "app-store",
      output_directory: "./build",
      output_name: "Lapses.ipa"
    )
  end

  # ==================
  # CI/CD
  # ==================

  desc "CI: Complete continuous integration workflow"
  lane :ci do
    lint
    build
    test
  end

  desc "CI: PR validation (lightweight)"
  lane :pr_check do
    lint
    build
    test
  end

  # ==================
  # VERSIONING
  # ==================

  desc "Bump patch version"
  lane :bump_patch do
    increment_build_number(
      xcodeproj: "outfind/lapses.xcodeproj"
    )
    increment_version_number(
      xcodeproj: "outfind/lapses.xcodeproj",
      bump_type: "patch"
    )
    version = get_version_number(xcodeproj: "outfind/lapses.xcodeproj")
    build = get_build_number(xcodeproj: "outfind/lapses.xcodeproj")
    UI.message("Version bumped to #{version} (#{build})")
  end

  desc "Bump minor version"
  lane :bump_minor do
    increment_build_number(
      xcodeproj: "outfind/lapses.xcodeproj"
    )
    increment_version_number(
      xcodeproj: "outfind/lapses.xcodeproj",
      bump_type: "minor"
    )
    version = get_version_number(xcodeproj: "outfind/lapses.xcodeproj")
    build = get_build_number(xcodeproj: "outfind/lapses.xcodeproj")
    UI.message("Version bumped to #{version} (#{build})")
  end

  desc "Bump major version"
  lane :bump_major do
    increment_build_number(
      xcodeproj: "outfind/lapses.xcodeproj"
    )
    increment_version_number(
      xcodeproj: "outfind/lapses.xcodeproj",
      bump_type: "major"
    )
    version = get_version_number(xcodeproj: "outfind/lapses.xcodeproj")
    build = get_build_number(xcodeproj: "outfind/lapses.xcodeproj")
    UI.message("Version bumped to #{version} (#{build})")
  end

  # ==================
  # DISTRIBUTION
  # ==================

  desc "Deploy to TestFlight"
  lane :beta do
    ensure_git_status_clean

    # Increment build number
    increment_build_number(xcodeproj: "outfind/lapses.xcodeproj")

    # Build
    build_release

    # Upload to TestFlight
    upload_to_testflight(
      skip_waiting_for_build_processing: true
    )

    # Commit version bump
    version = get_version_number(xcodeproj: "outfind/lapses.xcodeproj")
    build = get_build_number(xcodeproj: "outfind/lapses.xcodeproj")

    commit_version_bump(
      xcodeproj: "outfind/lapses.xcodeproj",
      message: "chore: bump version to #{version} (#{build})"
    )
  end

  desc "Deploy to App Store"
  lane :release do
    ensure_git_status_clean

    # Run tests first
    test

    # Build release
    build_release

    # Upload to App Store
    upload_to_app_store(
      skip_screenshots: true,
      skip_metadata: true,
      precheck_include_in_app_purchases: false
    )
  end

  # ==================
  # UTILITIES
  # ==================

  desc "Clean build artifacts"
  lane :clean do
    clear_derived_data
    sh("rm -rf ../test_output")
    sh("rm -rf ../build")
    sh("rm -rf ../coverage")
    UI.success("Cleaned all build artifacts!")
  end

  desc "Setup development environment"
  lane :setup do
    # Install dependencies
    sh("bundle install")

    # Install SwiftLint if not present
    sh("which swiftlint || brew install swiftlint")

    UI.success("Development environment ready!")
  end

  # ==================
  # ERROR HANDLING
  # ==================

  error do |lane, exception|
    UI.error("Lane #{lane} failed with error: #{exception.message}")
  end
end
